<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minimal Video Player</title>

<style>
    body {
        margin: 0;
        font-family: system-ui, -apple-system, sans-serif;
        background: #0f0f0f;
        color: #e5e5e5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    .container {
        width: 95%;
        max-width: 800px;
        text-align: center;
    }

    h1 {
        font-size: 1.4rem;
        font-weight: 500;
        margin-bottom: 20px;
        color: #ffffff;
    }

    .controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    label, button {
        background: #1f1f1f;
        border: 1px solid #2c2c2c;
        color: #e5e5e5;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: 0.2s ease;
    }

    label:hover, button:hover {
        background: #2a2a2a;
    }

    input[type="file"] {
        display: none;
    }

    video {
        width: 100%;
        max-height: 65vh;
        border-radius: 8px;
        background: black;
        display: none;
        transition: box-shadow 0.3s ease;
    }

    #status {
        font-size: 0.85rem;
        margin-top: 10px;
        color: #888;
        min-height: 20px;
    }

    .ready {
        box-shadow: 0 0 20px rgba(255,255,255,0.12);
    }
</style>
</head>

<body>

<div class="container">
    <h1>Reprodutor de Vídeo</h1>

    <div class="controls">
        <label for="videoInput">Vídeo</label>
        <input type="file" id="videoInput" accept="video/*">

        <label for="subtitleInput">Legenda</label>
        <input type="file" id="subtitleInput" accept=".srt">

        <button id="resetBtn">Limpar</button>
    </div>

    <video id="videoPlayer" controls></video>

    <div id="status" role="status" aria-live="polite">
        Selecione um vídeo.
    </div>
</div>

<script>

const videoPlayer = document.getElementById('videoPlayer');
const videoInput = document.getElementById('videoInput');
const subtitleInput = document.getElementById('subtitleInput');
const resetBtn = document.getElementById('resetBtn');
const status = document.getElementById('status');

let currentVideoKey = null;
let currentVideoBlobUrl = null;
let currentSubtitleBlobUrl = null;

/* ---------- STATUS ---------- */

function updateStatus(message, ready = false) {
    status.textContent = message;
    status.style.color = ready ? "#4CAF50" : "#888";
}

/* ---------- VIDEO ---------- */

function loadVideo(file) {

    if (videoPlayer.canPlayType(file.type) === '') {
        updateStatus("Formato de vídeo não suportado.");
        return;
    }

    if (currentVideoBlobUrl) {
        URL.revokeObjectURL(currentVideoBlobUrl);
    }

    const videoURL = URL.createObjectURL(file);
    videoPlayer.src = videoURL;
    videoPlayer.style.display = "block";

    currentVideoBlobUrl = videoURL;
    currentVideoKey = file.name + "-" + file.size;

    updateStatus("Vídeo carregado. Adicione legenda (opcional).");

    videoPlayer.onloadeddata = function() {
        const savedTime = localStorage.getItem("resume-" + currentVideoKey);
        if (savedTime && videoPlayer.duration > 0) {
            videoPlayer.currentTime = parseFloat(savedTime);
            updateStatus("Retomado de onde parou.");
        }
    };
}

/* ---------- LEGENDA COM CORREÇÃO DE ENCODING ---------- */

function loadSubtitle(file) {

    if (currentSubtitleBlobUrl) {
        URL.revokeObjectURL(currentSubtitleBlobUrl);
    }

    updateStatus("Carregando legenda...");

    const reader = new FileReader();

    reader.onload = function(e) {

        const buffer = e.target.result;
        let text;

        try {
            // tenta UTF-8 primeiro
            const decoder = new TextDecoder("utf-8", { fatal: true });
            text = decoder.decode(buffer);
        } catch {
            // fallback ISO-8859-1
            const decoder = new TextDecoder("iso-8859-1");
            text = decoder.decode(buffer);
        }

        videoPlayer.querySelectorAll('track').forEach(t => t.remove());

        text = text.replace(/\r\n/g, '\n');

        const vtt = "WEBVTT\n\n" +
            text.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');

        const blob = new Blob([vtt], { type: 'text/vtt' });
        const url = URL.createObjectURL(blob);

        currentSubtitleBlobUrl = url;

        const track = document.createElement('track');
        track.kind = "subtitles";
        track.label = "Legenda";
        track.srclang = "pt";
        track.src = url;
        track.default = true;

        videoPlayer.appendChild(track);
        videoPlayer.classList.add("ready");

        updateStatus("Legenda carregada.", true);
    };

    reader.onerror = function() {
        updateStatus("Erro ao ler legenda.");
    };

    reader.readAsArrayBuffer(file);
}

/* ---------- SALVAR POSIÇÃO ---------- */

videoPlayer.addEventListener('timeupdate', () => {

    if (!currentVideoKey || !videoPlayer.duration) return;

    if (videoPlayer.duration - videoPlayer.currentTime > 1) {

        localStorage.setItem(
            "resume-" + currentVideoKey,
            videoPlayer.currentTime
        );

    } else {

        localStorage.removeItem("resume-" + currentVideoKey);

    }
});

/* ---------- RESET ---------- */

resetBtn.addEventListener('click', () => {

    videoPlayer.pause();
    videoPlayer.removeAttribute("src");
    videoPlayer.load();

    videoPlayer.style.display = "none";
    videoPlayer.classList.remove("ready");

    videoPlayer.querySelectorAll('track').forEach(t => t.remove());

    videoInput.value = "";
    subtitleInput.value = "";

    currentVideoKey = null;

    updateStatus("Arquivos removidos.");
});

/* ---------- EVENTOS ---------- */

videoInput.addEventListener('change', e => {
    if (e.target.files[0]) loadVideo(e.target.files[0]);
});

subtitleInput.addEventListener('change', e => {
    if (e.target.files[0]) loadSubtitle(e.target.files[0]);
});

window.addEventListener('beforeunload', () => {
    if (currentVideoBlobUrl) URL.revokeObjectURL(currentVideoBlobUrl);
    if (currentSubtitleBlobUrl) URL.revokeObjectURL(currentSubtitleBlobUrl);
});

</script>

</body>
</html>
